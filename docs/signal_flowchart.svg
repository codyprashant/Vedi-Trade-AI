<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1400" height="1800" viewBox="0 0 1400 1800">
  <defs>
    <style>
      .box { fill:#ffffff; stroke:#2d3748; stroke-width:2; rx:8; ry:8; }
      .diamond { fill:#ffffff; stroke:#2d3748; stroke-width:2; }
      .ellipse { fill:#ffffff; stroke:#2d3748; stroke-width:2; }
      .arrow { stroke:#2d3748; stroke-width:2; fill:none; marker-end:url(#arrowhead); }
      .text { font-family: Arial, sans-serif; font-size:14px; fill:#1a202c; }
      .caption { font-size:13px; fill:#4a5568; }
      .note { fill:#edf2f7; stroke:#cbd5e0; stroke-width:1; rx:6; ry:6; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2d3748" />
    </marker>
  </defs>

  <!-- Title -->
  <text class="text" x="700" y="40" text-anchor="middle" font-size="22">Signal Generation Flow (M15 validated by H1, H4 additive boosts)</text>
  <text class="caption" x="700" y="65" text-anchor="middle">Final strength = min(100, base_strength + H1_boost + H4_boost); persist when ≥ threshold</text>

  <!-- Start -->
  <ellipse class="ellipse" cx="700" cy="110" rx="90" ry="30" />
  <text class="text" x="700" y="115" text-anchor="middle">Start (per symbol)</text>

  <!-- Load Strategy Config -->
  <rect class="box" x="500" y="160" width="400" height="80" />
  <text class="text" x="700" y="190" text-anchor="middle">Load active strategy config</text>
  <text class="caption" x="700" y="213" text-anchor="middle">params, weights, timeframes, signal_threshold, symbols</text>

  <!-- Fetch Data -->
  <rect class="box" x="500" y="270" width="400" height="80" />
  <text class="text" x="700" y="300" text-anchor="middle">Fetch history (M15, H1, H4)</text>
  <text class="caption" x="700" y="323" text-anchor="middle">count ≈ DEFAULT_HISTORY_COUNT</text>

  <!-- Arrow down -->
  <path class="arrow" d="M700,140 L700,160" />
  <path class="arrow" d="M700,240 L700,270" />

  <!-- Data sufficient? -->
  <polygon class="diamond" points="700,380 780,420 700,460 620,420" />
  <text class="text" x="700" y="425" text-anchor="middle">Data sufficient?</text>

  <!-- No branch: skip -->
  <path class="arrow" d="M620,420 C540,420 500,480 500,540" />
  <rect class="note" x="380" y="540" width="240" height="70" />
  <text class="text" x="500" y="565" text-anchor="middle">Log "insufficient_data"</text>
  <text class="caption" x="500" y="588" text-anchor="middle">continue next symbol</text>

  <!-- Yes branch: continue down -->
  <path class="arrow" d="M780,420 C860,420 900,480 900,540" />

  <!-- Compute indicators -->
  <rect class="box" x="700" y="540" width="400" height="80" />
  <text class="text" x="900" y="570" text-anchor="middle">Compute M15 indicators</text>
  <text class="caption" x="900" y="593" text-anchor="middle">RSI, MACD, SMA/EMA, BBANDS, STOCH, ATR, PA</text>

  <!-- Evaluate signals & strategy -->
  <rect class="box" x="700" y="640" width="400" height="90" />
  <text class="text" x="900" y="670" text-anchor="middle">Evaluate per-indicator directions</text>
  <text class="caption" x="900" y="693" text-anchor="middle">Compute strategy strengths; select best</text>

  <!-- Best direction? -->
  <polygon class="diamond" points="900,760 980,800 900,840 820,800" />
  <text class="text" x="900" y="805" text-anchor="middle">Best direction?</text>

  <!-- No: log no_action -->
  <path class="arrow" d="M820,800 C760,800 720,860 720,920" />
  <rect class="note" x="600" y="920" width="240" height="70" />
  <text class="text" x="720" y="945" text-anchor="middle">Log "no_action"</text>
  <text class="caption" x="720" y="968" text-anchor="middle">continue next symbol</text>

  <!-- Yes: compute H1/H4 trend & ATR cache -->
  <path class="arrow" d="M980,800 C1040,800 1080,860 1080,920" />
  <rect class="box" x="960" y="920" width="240" height="90" />
  <text class="text" x="1080" y="950" text-anchor="middle">Compute H1/H4 trend</text>
  <text class="caption" x="1080" y="973" text-anchor="middle">EMA(50/200), ATR last & mean50 cache</text>

  <!-- M15 aligns with H1? -->
  <polygon class="diamond" points="1080,1040 1160,1080 1080,1120 1000,1080" />
  <text class="text" x="1080" y="1085" text-anchor="middle">M15 aligns with H1?</text>

  <!-- No branch: run vs manual -->
  <path class="arrow" d="M1000,1080 C940,1080 900,1140 900,1200" />
  <rect class="note" x="780" y="1200" width="240" height="120" />
  <text class="text" x="900" y="1230" text-anchor="middle">Misaligned</text>
  <text class="caption" x="900" y="1253" text-anchor="middle">Run: skip signal</text>
  <text class="caption" x="900" y="1278" text-anchor="middle">Manual compute: summarize & continue</text>

  <!-- Yes branch: continue -->
  <path class="arrow" d="M1160,1080 C1220,1080 1260,1140 1260,1200" />

  <!-- Volatility classification -->
  <rect class="box" x="1140" y="1200" width="240" height="90" />
  <text class="text" x="1260" y="1230" text-anchor="middle">Volatility classification</text>
  <text class="caption" x="1260" y="1253" text-anchor="middle">Extreme (skip) / High / Normal / Low via H1 ATR</text>

  <!-- Extreme? -->
  <polygon class="diamond" points="1260,1320 1340,1360 1260,1400 1180,1360" />
  <text class="text" x="1260" y="1365" text-anchor="middle">Extreme?</text>
  <path class="arrow" d="M1180,1360 C1120,1360 1080,1420 1080,1480" />
  <rect class="note" x="960" y="1480" width="240" height="70" />
  <text class="text" x="1080" y="1505" text-anchor="middle">Skip due to extreme</text>
  <text class="caption" x="1080" y="1528" text-anchor="middle">continue next symbol</text>

  <!-- If not extreme: trade plan -->
  <path class="arrow" d="M1340,1360 C1400,1360 1440,1420 1440,1480" />
  <rect class="box" x="1320" y="1480" width="240" height="110" />
  <text class="text" x="1440" y="1510" text-anchor="middle">Compute trade plan</text>
  <text class="caption" x="1440" y="1533" text-anchor="middle">Entry, SL, TP, RR; bounds by volatility</text>

  <!-- Contributions (base strength) -->
  <rect class="box" x="1320" y="1620" width="240" height="100" />
  <text class="text" x="1440" y="1650" text-anchor="middle">Indicator contributions</text>
  <text class="caption" x="1440" y="1673" text-anchor="middle">RSI, MACD, SMA_EMA, BBANDS, STOCH, MTF, ATR_STABILITY, PA</text>

  <!-- Alignment boosts and final -->
  <rect class="box" x="1040" y="1620" width="240" height="100" />
  <text class="text" x="1160" y="1650" text-anchor="middle">Alignment boosts</text>
  <text class="caption" x="1160" y="1673" text-anchor="middle">+H1 (if M15 aligns H1), +H4 (if H4 agrees with H1)</text>

  <!-- Arrow from trade plan to contributions & boosts -->
  <path class="arrow" d="M1440,1590 C1440,1605 1440,1605 1440,1615" />
  <path class="arrow" d="M1440,1590 C1300,1600 1200,1600 1160,1615" />

  <!-- Final strength decision -->
  <polygon class="diamond" points="1160,1750 1230,1790 1160,1830 1090,1790" />
  <text class="text" x="1160" y="1795" text-anchor="middle">Final ≥ threshold?</text>

  <!-- Yes: insert signal -->
  <path class="arrow" d="M1230,1790 C1290,1790 1330,1850 1330,1910" />
  <rect class="box" x="1210" y="1910" width="240" height="90" />
  <text class="text" x="1330" y="1940" text-anchor="middle">Insert signal to DB</text>
  <text class="caption" x="1330" y="1963" text-anchor="middle">Log metrics; update frequency</text>

  <!-- No: log skipped -->
  <path class="arrow" d="M1090,1790 C1030,1790 990,1850 990,1910" />
  <rect class="note" x="870" y="1910" width="240" height="70" />
  <text class="text" x="990" y="1935" text-anchor="middle">Log "insert skipped"</text>
  <text class="caption" x="990" y="1958" text-anchor="middle">summarize & continue</text>

  <!-- Indicator snapshot side-action -->
  <rect class="note" x="160" y="920" width="260" height="100" />
  <text class="text" x="290" y="950" text-anchor="middle">Indicator snapshots</text>
  <text class="caption" x="290" y="973" text-anchor="middle">Run: every ≥10 min; Manual: opportunistic</text>

  <!-- Legend -->
  <rect x="60" y="60" width="280" height="160" class="note" />
  <text class="text" x="200" y="90" text-anchor="middle">Legend</text>
  <rect x="80" y="110" width="20" height="20" class="box" />
  <text class="caption" x="110" y="125"> Process</text>
  <polygon points="80,150 100,160 80,170 60,160" class="diamond" />
  <text class="caption" x="110" y="165"> Decision</text>
  <ellipse cx="90" cy="190" rx="10" ry="10" class="ellipse" />
  <text class="caption" x="110" y="195"> Start/End</text>

</svg>